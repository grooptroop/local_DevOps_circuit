# homelab-devops-platform

Система представляет собой локальный DevOps контур вокруг k3s-кластера

[Инструкция по установке](/md-file/Install.md)

---
## Стек технологий:

- K3S
- MetalLB
- Docker-registry
- Gieta
- Drone CI
- Prometheus
- Grafana

---

## Общая структура:
<img width="1158" height="849" alt="image" src="https://github.com/user-attachments/assets/b8a9cde0-3e7d-4454-ad38-fcf0ccb1cdf1" />

---

## K3S

За основу был взят k3s кластер в виду ограниченных ресурсов моего rasberry pi + тестового стенда для демонстраций работы технологии.

Кластер представляет из сбея `одну сервер ноду` на которой развёрнуты все основные сервесы + `одна agent нода`, но можно подключить до ~900 нод (при 8 CPU и 16 GB RAM)

## MetalLB

В нашем проекте выпалняет две роли

- Пул `IPAddressPool` с диапазоном в нашем случае `192.168.1.200-192.168.1.210`
- Раздача IP по L2 в локальной сети(`L2Advertisement`)

## Docker registry

Представляет с собой локальное хранилище для образов который доступен по адресу `192.168.1.70:30500` 

пример структуры названия образа для загрузки в registry - `192.168.1.70:30500/our-task/nginx-demo:latest`

## Gitea
<img width="1916" height="838" alt="image" src="https://github.com/user-attachments/assets/669e62c4-a237-4891-bbd0-4308b496bb2f" />

Локальный Git сервер в котором лежат репозитории кода и через который Drone запускает CI/CD пайплайны.

Создаёт вебхук с Drone CI для полноценного развёртования новых билдов.

## Drone CI
<img width="1918" height="843" alt="image" src="https://github.com/user-attachments/assets/a6d0c9c9-6274-4a4a-b962-fda39218d9b3" />

Движок CI/CD, который реагирует на комиты в Gitea и в k3s запускает контейнерные пайплайны сборки деплоя по `.drone.yml`

Drone runner развёрнут в кластере и запускает шаги как podы, используя ресурсы k3s стенда и изолируя каждый билд.

При пуше новой версии приложения, создаётся новый под, если он нормально ставиться, старый под с предидушщей версии уничтожается.

## Prometheus

Система мониторинга и time-series база. Хранит числовые метрики с метками времени. 

Prometheus по HTTP опрашивает компоненты Kubernetes и приложения, сохраняет метрики во встроенную time series базу и служит источником данных для Grafana и alerting-правил

## Grafana 
<img width="1914" height="986" alt="image" src="https://github.com/user-attachments/assets/097031c3-dfda-4e93-bad7-b61161bb8fdf" />

Платформа визуализаци: строит графики, таблици и алёры на основе данных из разных источников.


--- 

## Принцип работы 

<img width="1431" height="553" alt="image" src="https://github.com/user-attachments/assets/1e864c1b-d935-4aa7-8dcb-a75050515a9a" />


- Пользователь делает `git push` в репозиторий Gitea. Gitea принимает комит и по настроеному `webhook` шлёт событие о пуше на Drone Server.

- `Drone server` находит активированный репозитьорий, подтягивает код и `.drone`, и создаёт новый билд. `Drone runner` забирает билд и запускает шаги pipeline. 

-  В нашкм случае поднимается Docker-образСобраный образ из `Dockerfile` приложкеия и собирает образ. Собраный образ пугится в `registry` под нужным именем и тегам.

- Pipeline обновляет Deployment  в кластере на новый тег образа. k3s делает `rolling update`: pods со старым образом постепенно заменяются на pods с новым, сервис автоматически начинает слать трафик на новые pods по лейблам.

- Drone сохраняет результаты выполнения каждого шага, и можно посмотреть логи, статус, ссылки на комиты в Gitea.  












